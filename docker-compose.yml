services:
  mcp-document-server:
    build: .
    container_name: mcp-document-server
    restart: unless-stopped
    env_file:
      - .env

    ports:
      - "8252:8000"
    
    volumes:
      - type: bind
        source: /mnt/gdrive
        target: /documents
        bind:
          propagation: shared
      - /etc/localtime:/etc/localtime:ro
      - /etc/timezone:/etc/timezone:ro

    environment:
      # Server configuration
      - MCP_TRANSPORT=sse
      - MCP_HOST=0.0.0.0
      - MCP_PORT=8000

      # Logging (DEBUG for verbose, INFO for normal, WARNING for quiet)
      - LOG_LEVEL=${LOG_LEVEL:-INFO}

      # Document settings
      - DOCUMENTS_PATH=/documents
      - MAX_FILE_SIZE_MB=10
      - MAX_VIDEO_SIZE_MB=500
      - ALLOWED_EXTENSIONS=.txt,.md,.pdf,.docx,.xlsx,.pptx,.csv,.json,.yaml,.yml,.log,.xml,.toml,.ini,.cfg
      
      # Authentication token (required for access) - set in .env or override
      - MCP_AUTH_TOKEN=${MCP_AUTH_TOKEN:-}

      # Allowed hosts for MCP transport security (Tailscale Funnel + localhost)
      - MCP_ALLOWED_HOSTS=frigate.taila099fd.ts.net,localhost,127.0.0.1

      # Public URL for generating download links (Tailscale Funnel URL)
      - MCP_PUBLIC_URL=https://frigate.taila099fd.ts.net

      # Whisper API for audio transcription (set to your GPU desktop's whisper endpoint)
      - WHISPER_API_URL=${WHISPER_API_URL:-http://host.docker.internal:8872/asr?task=transcribe&output=vtt&language=en&diarize=true}
      - WHISPER_SCAN_INTERVAL=${WHISPER_SCAN_INTERVAL:-60}

      # Recordings and speaker identification settings
      - RECORDINGS_DIR=${RECORDINGS_DIR:-Recordings}
      - SPEAKERS_DIR=${SPEAKERS_DIR:-speakers}
      - SPEAKER_SIMILARITY_THRESHOLD=${SPEAKER_SIMILARITY_THRESHOLD:-0.75}
    
    extra_hosts:
      - "host.docker.internal:host-gateway"

    networks:
      - mcp-network
    
    logging:
      driver: "journald"
      options:
        tag: "mcp-document-server"
    
    # Security options
    security_opt:
      - no-new-privileges:true
    
    # Resource limits
    deploy:
      resources:
        limits:
          cpus: '1.0'
          memory: 1536M
        reservations:
          cpus: '0.25'
          memory: 256M

networks:
  mcp-network:
    driver: bridge
